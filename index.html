<body>
  <h1>iNaturalist Observation Stats</h1>

  <div id="stats-container" style="display: flex; gap: 2rem;">
    <!-- Evening event summary -->
    <div id="dpp-evening-list" style="margin-top: 2rem;">
        <h2>🌙 National Moth Week at DPP</h2>
        <p>Loading evening insect stats...</p>
  </div>
    
    <!-- Overall summaries -->
    <div id="deer-park" class="location-box" style="flex: 1;">
      <h2>📍 Deer Park Prairie</h2>
      <p id="deer-stats">Loading data...</p>
      <ul id="deer-list"></ul>
    </div>

    <div id="exploration-green" class="location-box" style="flex: 1;">
      <h2>📍 Exploration Green</h2>
      <p id="eg-stats">Loading data...</p>
      <ul id="eg-list"></ul>
    </div>
  </div>

  <!-- Script 1: NMW at DPP insect summary | 7-26-25 -->
  <script>
    async function loadEveningInsectObservers(placeId, date, containerId, max = 5) {
      const url = `https://api.inaturalist.org/v1/observations?place_id=${placeId}&d1=${date}&d2=${date}&taxon_id=47158&per_page=200`;
      try {
        const response = await fetch(url);
        const data = await response.json();

        const evening = data.results.filter(obs => {
          const hour = new Date(obs.time_observed_at).getHours();
          return hour >= 19 && hour < 24;
        });

        const totalObservations = evening.length;

        const speciesSet = new Set(
          evening
            .filter(obs => obs.taxon && obs.taxon.rank === "species")
            .map(obs => obs.taxon.name)
        );
        const uniqueSpecies = speciesSet.size;

        const observerCounts = {};
        evening.forEach(obs => {
          const user = obs.user?.login || "unknown";
          observerCounts[user] = (observerCounts[user] || 0) + 1;
        });

        const sorted = Object.entries(observerCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, max);

        const container = document.getElementById(containerId);
        if (totalObservations === 0) {
          container.innerHTML = `<p>No insect observations recorded between 7pm–12am on ${date}.</p>`;
          return;
        }

        container.innerHTML = `
          <p><strong>${totalObservations}</strong> insect observations between 7pm–12am on ${date}</p>
          <p><strong>${uniqueSpecies}</strong> unique species observed</p>
          <p>Top ${max} observers:</p>
          <ul>
            ${sorted.map(([user, count]) => `<li>${user} — ${count} observations</li>`).join("")}
          </ul>
        `;
      } catch (err) {
        console.error("Evening stats failed:", err);
        const container = document.getElementById(containerId);
        if (container) {
          container.innerHTML = "<p>Failed to load data.</p>";
        }
      }
    }

    // Run evening summary
    loadEveningInsectObservers(189476, "2025-07-26", "dpp-evening-list", 5);
  </script>
  
  
  <!-- Script 2: Standard stats and observers -->
  <script>
    async function loadObservationStats(placeId, statsId) {
      const url = `https://api.inaturalist.org/v1/observations?place_id=${placeId}`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
        const data = await response.json();
        const statsEl = document.getElementById(statsId);
        if (statsEl) statsEl.textContent = `${data.total_results.toLocaleString()} total observations`;
      } catch (error) {
        console.error("Stats fetch failed:", error);
        const statsEl = document.getElementById(statsId);
        if (statsEl) statsEl.textContent = "Failed to load observation count.";
      }
    }

    async function loadObservers(placeId, listId) {
      const url = `https://api.inaturalist.org/v1/observations/observers?place_id=${placeId}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        const listEl = document.getElementById(listId);
        listEl.innerHTML = "";
        data.results.forEach(observer => {
          const li = document.createElement("li");
          li.textContent = `${observer.user.login} — ${observer.observation_count} observations`;
          listEl.appendChild(li);
        });
      } catch (error) {
        console.error("Observer fetch failed:", error);
        document.getElementById(listId).innerHTML = "<li>Failed to load data.</li>";
      }
    }

    // Run standard calls
    loadObservationStats(189476, "deer-stats");
    loadObservers(189476, "deer-list");

    loadObservationStats(120329, "eg-stats");
    loadObservers(120329, "eg-list");
  </script>

</body>
